// history.js - Fixed Version

const API_BASE_URL = 'https://api.goreportify.com'; // ç¡®ä¿è¿™ä¸ªåœ°å€æ˜¯ä½ çš„åç«¯åœ°å€

// é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
document.addEventListener('DOMContentLoaded', () => {
    fetchHistory();
});

// è·å–å†å²è®°å½•æ ¸å¿ƒé€»è¾‘
async function fetchHistory() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'index.html'; // æœªç™»å½•è¸¢å›é¦–é¡µ
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/api/reports/history`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to fetch history');

        const reports = await response.json();
        renderHistoryList(reports);
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('history-list').innerHTML = '<p style="color:white;">æ— æ³•åŠ è½½å†å²è®°å½•ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>';
    }
}

// æ¸²æŸ“åˆ—è¡¨
function renderHistoryList(reports) {
    const listContainer = document.getElementById('history-list');
    listContainer.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

    if (reports.length === 0) {
        listContainer.innerHTML = '<p style="color:white;">æš‚æ— å†å²æŠ¥å‘Šã€‚</p>';
        return;
    }

    reports.forEach(report => {
        const card = document.createElement('div');
        card.className = 'history-card'; // ç¡®ä¿ä½ çš„CSSé‡Œæœ‰è¿™ä¸ªæ ·å¼ï¼Œæˆ–è€…æ²¿ç”¨ä¹‹å‰çš„
        // ç®€å•æ ·å¼ï¼Œä¿è¯å¡ç‰‡å¯è§
        card.style.background = 'rgba(255,255,255,0.1)';
        card.style.padding = '15px';
        card.style.marginBottom = '10px';
        card.style.borderRadius = '8px';
        card.style.color = 'white';
        card.style.cursor = 'pointer';

        const date = new Date(report.createdAt).toLocaleDateString();
        card.innerHTML = `
            <h3>${report.title || 'æœªå‘½åæŠ¥å‘Š'}</h3>
            <p><small>${date}</small></p>
        `;
        
        // ç‚¹å‡»å¡ç‰‡æ˜¾ç¤ºå¼¹çª—
        card.onclick = () => showReportDetail(report);
        listContainer.appendChild(card);
    });
}

// ==========================================
// ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šå¼¹çª—ä¸å¯¼å‡ºé€»è¾‘
// ==========================================

// 1. Word å¯¼å‡ºå‡½æ•°
function exportHistoryToWord(content, filename) {
    if (!content) return alert("å†…å®¹ä¸ºç©º");
    const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export</title></head><body>";
    const footer = "</body></html>";
    let htmlBody = (typeof marked !== 'undefined') ? marked.parse(content) : content.replace(/\n/g, "<br>");
    const sourceHTML = header + htmlBody + footer;
    const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
    const link = document.createElement("a");
    document.body.appendChild(link);
    link.href = source;
    link.download = filename + '.doc';
    link.click();
    document.body.removeChild(link);
}

// 2. PDF å¯¼å‡ºå‡½æ•° (å¿«ç…§æ³• - ä¿®å¤ç©ºç™½é—®é¢˜)
function exportHistoryToPDF(content, filename) {
    if (!content) return alert("å†…å®¹ä¸ºç©º");
    
    // åˆ›å»ºä¸´æ—¶å®¹å™¨ (ä¸å—ç½‘é¡µæš—è‰²èƒŒæ™¯å¹²æ‰°)
    const element = document.createElement('div');
    element.style.width = '800px';
    element.style.padding = '40px';
    element.style.fontFamily = 'Arial, sans-serif';
    element.style.background = '#fff';
    element.style.color = '#000';
    
    const htmlContent = (typeof marked !== 'undefined') ? marked.parse(content) : content;
    element.innerHTML = `
        <h2 style="text-align:center; color:#333;">${filename}</h2>
        <hr style="margin:20px 0; border:0; border-top:1px solid #ccc;">
        <div style="line-height:1.6;">${htmlContent}</div>
        <div style="margin-top:50px; text-align:center; color:#999; font-size:12px;">Generated by Reportify AI</div>
    `;

    // æ£€æŸ¥ html2pdf æ˜¯å¦åŠ è½½
    if (typeof html2pdf !== 'undefined') {
        const opt = {
            margin: 10,
            filename: filename + '.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().from(element).set(opt).save();
    } else {
        alert("PDF ç»„ä»¶æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢æ£€æŸ¥ç½‘ç»œã€‚");
    }
}

// 3. å¼¹çª—æ˜¾ç¤ºé€»è¾‘ (åŠ¨æ€åˆ›å»ºï¼Œæ›¿æ¢æ—§çš„ HTML modal)
function showReportDetail(report) {
    // ç§»é™¤æ—§å¼¹çª—
    const old = document.getElementById('dm');
    if (old) old.remove();
    // åŒæ—¶ä¹Ÿç§»é™¤å¯èƒ½å­˜åœ¨çš„é™æ€HTMLå¼¹çª—ï¼ˆé˜²æ­¢åŒé‡å¼¹çª—ï¼‰
    const staticModal = document.getElementById('report-modal');
    if (staticModal) staticModal.classList.add('hidden');

    const overlay = document.createElement('div');
    overlay.id = 'dm';
    // ä½¿ç”¨ Tailwind ç±» (å¦‚æœä¸ç”Ÿæ•ˆï¼Œä¼šè‡ªåŠ¨å›é€€åˆ°æ— æ ·å¼ï¼Œä½†é€»è¾‘ä»åœ¨)
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    // å¼ºåˆ¶æ ·å¼ç¡®ä¿å±…ä¸­è¦†ç›–
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.zIndex = '9999';
    
    const htmlContent = (typeof marked !== 'undefined') ? marked.parse(report.content) : report.content;

    overlay.innerHTML = `
        <div style="background:white; color:black; width:90%; max-width:800px; height:80%; display:flex; flex-direction:column; border-radius:8px; overflow:hidden;">
            <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:20px;">${report.title || 'æŠ¥å‘Šè¯¦æƒ…'}</h3>
                <button onclick="document.getElementById('dm').remove()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div style="flex:1; padding:20px; overflow-y:auto; line-height:1.6;">
                ${htmlContent}
            </div>
            <div style="padding:20px; background:#f9f9f9; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px;">
                <button id="btn-word" style="padding:10px 20px; background:#2563EB; color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ“„ ä¸‹è½½ Word</button>
                <button id="btn-pdf" style="padding:10px 20px; background:#DC2626; color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ“• ä¸‹è½½ PDF</button>
                <button onclick="document.getElementById('dm').remove()" style="padding:10px 20px; background:#ccc; border:none; border-radius:4px; cursor:pointer;">å…³é—­</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    // å»¶æ—¶ç»‘å®šäº‹ä»¶ï¼Œç¡®ä¿DOMå·²æ’å…¥
    setTimeout(() => {
        document.getElementById('btn-word').onclick = () => exportHistoryToWord(report.content, report.title || 'Report');
        document.getElementById('btn-pdf').onclick = () => exportHistoryToPDF(report.content, report.title || 'Report');
    }, 50);
}
