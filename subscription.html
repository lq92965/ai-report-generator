<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade Plan - Reportify AI</title>
    <link rel="stylesheet" href="style.css?v=9.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.paypal.com/sdk/js?client-id=AeJjXRJe0H2XbqAwcw8zNA3-3ms0im4_QhK8E9p9FwzivH6yjFqjs-yus4oyZUTnG8Rx8udHY_DXl2Rc&currency=USD"></script>
</head>
<body style="background-color: #f8f9fa;">

    <header class="main-header account-header">
        <div class="container">
            <a href="index.html" class="logo">
                <span class="logo-icon">ğŸ¦</span> <span>Reportify AI</span>
            </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html#generator">Generator</a></li>
                    <li><a href="account.html">My Account</a></li>
                </ul>
            </nav>
            <div id="auth-container" class="header-actions"></div>
    </header>

    <div style="width: 100%; background: #f8f9fa; padding: 20px 0;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px; text-align: left;">
            <a href="account.html" style="display: inline-flex; align-items: center; gap: 8px; text-decoration: none; color: #666; font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-arrow-left"></i> Back to Account Hub
            </a>
        </div>
    </div>

    <div class="container" style="max-width: 1200px; margin: 0 auto 40px; text-align: center; padding: 0 20px;">
        <h1 style="font-size: 2.5rem; color: #333; margin-bottom: 10px;">Choose Your Plan</h1>
        <p style="color: #666; font-size: 1rem; margin-bottom: 20px;">
            Unlock the full potential of AI reporting.
        </p>
        <span style="font-size: 0.9rem; background: #eef; padding: 6px 12px; border-radius: 20px; color: #555;">
            Current Plan: <span id="current-plan-badge" style="font-weight:bold; color:#007bff">LOADING...</span>
        </span>
    </div>

    <div class="pricing-grid">
            
        <div class="pricing-card" data-plan="free">
            <h3>Free Trial</h3>
            <div class="price">$0<span>/ 7 days</span></div>
            
            <ul class="features-list">
                <li><i class="fas fa-check" style="color:#28a745"></i> <strong>3 Reports</strong> per day</li>
                <li><i class="fas fa-check" style="color:#28a745"></i> Standard AI Model</li>
                <li><i class="fas fa-check" style="color:#28a745"></i> Word Export</li>
                <li class="disabled"><i class="fas fa-times-circle"></i> Smart AI Engine</li>
                <li class="disabled"><i class="fas fa-times-circle"></i> Long Input (100k)</li>
            </ul>
            
            <button class="btn btn-secondary full-width" onclick="window.location.href='index.html'">Start Free</button>
        </div>

        <div class="pricing-card" data-plan="basic">
            <h3>Basic</h3>
            <div class="price">$9.90<span>/ mo</span></div>
            <ul class="features-list">
                <li><i class="fas fa-check" style="color:#007bff"></i> <strong>45 Reports</strong> / month</li>
                <li><i class="fas fa-check" style="color:#007bff"></i> <strong>Smart AI</strong> Engine</li>
                <li><i class="fas fa-check" style="color:#007bff"></i> Input Limit: <strong>5,000 chars</strong></li>
                <li><i class="fas fa-check" style="color:#007bff"></i> PDF & Word Export</li>
                <li><i class="fas fa-info-circle" style="color:#ccc"></i> Professional Tone Only</li>
            </ul>
            <button class="btn btn-secondary full-width choose-plan-btn" data-plan="basic" data-price="9.90">Select Basic</button>
        </div>

        <div class="pricing-card featured plan-active" data-plan="pro">
            <div class="best-value-text">Recommended</div>
            <h3>Professional</h3>
            <div class="price">$19.90<span>/ mo</span></div>
            <ul class="features-list">
                <li><i class="fas fa-bolt" style="color:#28a745"></i> <strong>Unlimited</strong> Generation</li>
                <li><i class="fas fa-brain" style="color:#28a745"></i> <strong>Advanced AI</strong> Engine</li>
                <li><i class="fas fa-file-alt" style="color:#28a745"></i> Long Input: <strong>100k chars</strong></li>
                <li><i class="fas fa-star" style="color:#28a745"></i> <strong>All Tones</strong> Unlocked</li>
                <li><i class="fas fa-crown" style="color:#28a745"></i> Priority Support</li>
            </ul>
            <button class="btn btn-primary full-width choose-plan-btn" data-plan="pro" data-price="19.90">Choose Pro</button>
        </div>

    </div>
        
    <div style="text-align: center; margin: 40px 0; color: #999; font-size: 0.8rem;">
        <p><i class="fab fa-paypal"></i> Secure payment via PayPal. Cancel anytime.</p>
    </div>

    <script src="nav.js"></script>
    <script src="script.js?v=9.0"></script>

    <script>
        // ==========================================
        // ğŸŸ¢ é¡µé¢åˆå§‹åŒ– & PayPal æ”¯ä»˜é€»è¾‘ (ä¿®å¤å®Œæ•´ç‰ˆ)
        // ==========================================
        
        // å…¨å±€å˜é‡ï¼Œè®°å½•ç”¨æˆ·å½“å‰é€‰äº†å“ªä¸ªå¥—é¤
        let selectedPlanId = 'pro'; 
        let selectedPlanPrice = '19.90';

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            
            // 1. åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯ (ä¿ç•™ä½ åŸæ¥çš„ä»£ç é€»è¾‘)
            if (token) {
                fetch('https://api.goreportify.com/api/me', { headers: { 'Authorization': `Bearer ${token}` }})
                    .then(res => res.json())
                    .then(user => {
                        if (window.updateUserNav) window.updateUserNav(user);
                        const plan = user.plan || 'free';
                        const badge = document.getElementById('current-plan-badge');
                        if(badge) badge.textContent = plan.toUpperCase();
                        
                        // è‡ªåŠ¨é«˜äº®å½“å‰è®¡åˆ’
                        document.querySelectorAll('.pricing-card').forEach(c => c.classList.remove('plan-active'));
                        const activeCard = document.querySelector(`.pricing-card[data-plan="${plan}"]`);
                        if(activeCard) activeCard.classList.add('plan-active');
                    })
                    .catch(() => {});
            }

            // 2. ç»‘å®š "é€‰æ‹©å¥—é¤" æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const buttons = document.querySelectorAll('.choose-plan-btn');
            const modal = document.getElementById('payment-modal-overlay');
            const modalTitle = document.getElementById('payment-plan-name');
            const closeBtn = document.getElementById('close-payment-btn');

            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // å¦‚æœæ²¡ç™»å½•ï¼Œå…ˆè®©ç™»å½•
                    if (!localStorage.getItem('token')) {
                        alert("Please login first to upgrade.");
                        // window.openModal('login'); // å¦‚æœä½ æœ‰è¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨ï¼Œæ²¡æœ‰å°±è·³è½¬
                        return; 
                    }

                    // è·å–æŒ‰é’®ä¸Šçš„å¥—é¤ä¿¡æ¯
                    selectedPlanId = btn.getAttribute('data-plan'); // 'basic' æˆ– 'pro'
                    selectedPlanPrice = btn.getAttribute('data-price'); // '9.90' æˆ– '19.90'

                    // æ›´æ–°å¼¹çª—æ–‡å­—
                    modalTitle.textContent = selectedPlanId === 'pro' ? 'Professional Plan ($19.90/mo)' : 'Basic Plan ($9.90/mo)';
                    
                    // æ˜¾ç¤ºå¼¹çª—
                    modal.style.display = 'flex';

                    // é‡æ–°æ¸²æŸ“ PayPal æŒ‰é’® (å…ˆæ¸…ç©ºå®¹å™¨ï¼Œé˜²æ­¢é‡å¤æ¸²æŸ“)
                    document.getElementById('paypal-button-container').innerHTML = '';
                    renderPayPalButtons();
                });
            });

            // 3. å…³é—­å¼¹çª—é€»è¾‘
            if(closeBtn) {
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
            }
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // ğŸŸ¢ æ ¸å¿ƒï¼šæ¸²æŸ“ PayPal æŒ‰é’®å¹¶å¤„ç†å›è°ƒ
        function renderPayPalButtons() {
            paypal.Buttons({
                // A. åˆ›å»ºè®¢å•
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            description: `Reportify AI - ${selectedPlanId.toUpperCase()} Plan`,
                            amount: {
                                value: selectedPlanPrice // åŠ¨æ€é‡‘é¢
                            }
                        }]
                    });
                },

                // B. æ”¯ä»˜æ‰¹å‡† (ç”¨æˆ·ä»˜æ¬¾æˆåŠŸ) --> è¿™å°±æ˜¯ä½ è¦æ‰¾çš„ onApproveï¼
                onApprove: function(data, actions) {
                    return actions.order.capture().then(async function(details) {
                        // 1. æ‹¿åˆ° Token
                        const token = localStorage.getItem('token');
                        
                        // 2. è°ƒç”¨åç«¯å‡çº§æ¥å£
                        try {
                            const response = await fetch('https://api.goreportify.com/api/upgrade-plan', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    planId: selectedPlanId, // å‘Šè¯‰åç«¯å‡åˆ°å“ªä¸€çº§
                                    paymentId: details.id   // PayPal è®¢å•å·
                                })
                            });

                            const result = await response.json();

                            if (result.success || response.ok) {
                                alert('Upgrade Successful! Welcome to Reportify AI ' + selectedPlanId.toUpperCase());
                                // 3. æˆåŠŸåè·³è½¬å›è´¦æˆ·é¡µ
                                window.location.href = 'account.html';
                            } else {
                                alert('Payment successful, but server update failed. Contact support.');
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Network error during upgrade. Please check your account.');
                        }
                    });
                },

                // C. é”™è¯¯å¤„ç†
                onError: function(err) {
                    console.error('PayPal Error:', err);
                    alert('Payment could not be completed. Please try again.');
                }
            }).render('#paypal-button-container');
        }
    </script>

    <div id="payment-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <span id="close-payment-btn" style="position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: #666;">&times;</span>
            
            <h3 style="text-align: center; margin-bottom: 5px; color: #333;">Complete Your Purchase</h3>
            <p id="payment-plan-name" style="text-align: center; color: #007bff; font-weight: bold; margin-bottom: 25px; font-size: 1.1rem;">Plan Name</p>
            
            <div id="paypal-button-container"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="script.js"></script>
</body>
</html>  
