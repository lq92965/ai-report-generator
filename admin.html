<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportify æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* é¡µé¢åŠ è½½å‰çš„é®ç½©ï¼Œé˜²æ­¢æœªç™»å½•çœ‹åˆ°å†…å®¹ */
        #app-loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div id="app-loader"><div class="animate-spin text-4xl text-blue-600"><i class="fas fa-circle-notch"></i></div></div>

    <div class="flex h-screen overflow-hidden">
        
        <aside class="w-64 bg-slate-900 text-white flex-shrink-0 hidden md:flex flex-col">
            <div class="p-6 flex items-center gap-3 border-b border-slate-800">
                <span class="text-2xl">ğŸ¦</span>
                <h1 class="text-xl font-bold tracking-wide">Reportify Admin</h1>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="flex items-center gap-3 px-4 py-3 bg-blue-600 rounded-lg text-white shadow-lg">
                    <i class="fas fa-tachometer-alt w-5"></i> ä»ªè¡¨ç›˜æ¦‚è§ˆ
                </a>
                <a href="#users" class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fas fa-users w-5"></i> ç”¨æˆ·ç®¡ç†
                </a>
                <a href="#feedback" class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fas fa-envelope w-5"></i> æ¶ˆæ¯åé¦ˆ
                </a>
                <a href="#finance" class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fas fa-wallet w-5"></i> è´¢åŠ¡åˆ†æ
                </a>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-red-400 hover:bg-red-900/30 rounded transition">
                    <i class="fas fa-sign-out-alt"></i> å®‰å…¨é€€å‡º
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10">
                <h2 class="text-lg font-semibold text-gray-700">ä»Šæ—¥æ¦‚å†µ</h2>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-500" id="admin-email">Loading...</span>
                    <div class="h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">A</div>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 relative overflow-hidden">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">æ€»ç”¨æˆ·æ•°</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-users">-</h3>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-lg text-blue-600"><i class="fas fa-users text-xl"></i></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">ä»˜è´¹ç”¨æˆ· (Pro)</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-pros">-</h3>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg text-purple-600"><i class="fas fa-crown text-xl"></i></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">åŸºç¡€ç‰ˆ (Basic)</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-basic">-</h3>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg text-green-600"><i class="fas fa-leaf text-xl"></i></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">å¾…å¤„ç†åé¦ˆ</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-unread">-</h3>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-lg text-yellow-600"><i class="fas fa-bell text-xl"></i></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-1">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ç”¨æˆ·æ„æˆåˆ†æ</h3>
                        <div class="relative h-64">
                            <canvas id="userChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm lg:col-span-2 flex flex-col">
                        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-800">æœ€æ–°åé¦ˆ / ç•™è¨€</h3>
                            <button onclick="loadData()" class="text-sm text-blue-600 hover:underline">åˆ·æ–°æ•°æ®</button>
                        </div>
                        <div id="msg-list" class="flex-1 overflow-y-auto max-h-[300px] p-0">
                            <div class="p-8 text-center text-gray-400">æ­£åœ¨è·å–æ•°æ®...</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800">æœ€æ–°æ³¨å†Œç”¨æˆ·</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-600 uppercase tracking-wider font-semibold">
                                <tr>
                                    <th class="px-6 py-3">ç”¨æˆ·</th>
                                    <th class="px-6 py-3">é‚®ç®±</th>
                                    <th class="px-6 py-3">å¥—é¤ç­‰çº§</th>
                                    <th class="px-6 py-3">æ³¨å†Œæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="user-list" class="divide-y divide-gray-100">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-8 text-center text-gray-400 text-sm">
                    Reportify AI Admin Panel v2.0 &copy; 2026
                </div>

            </main>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.goreportify.com';
        
        // 1. å®‰å…¨æ£€æŸ¥ (Security Check)
        // åªè¦æ²¡æœ‰ tokenï¼Œç«‹åˆ»è¸¢å›é¦–é¡µï¼Œä¸æ˜¾ç¤ºä»»ä½• HTML
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'index.html?error=admin_login_required';
        } else {
            // æœ‰ Token æ‰ç§»é™¤é®ç½©
            document.getElementById('app-loader').style.display = 'none';
            parseTokenEmail();
        }

        function parseTokenEmail() {
            try {
                // ç®€å•çš„ JWT è§£æä»¥æ˜¾ç¤ºå³ä¸Šè§’é‚®ç®±
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                const user = JSON.parse(jsonPayload);
                // æ³¨æ„ï¼šJWTé‡Œé€šå¸¸ä¸å­˜emailï¼Œé™¤éä½ å­˜äº†ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±æ˜¾ç¤º Admin
                document.getElementById('admin-email').innerText = 'Administrator'; 
            } catch (e) {}
        }

        // 2. åˆå§‹åŒ–åŠ è½½
        document.addEventListener('DOMContentLoaded', loadData);

        async function loadData() {
            try {
                // 2.1 è·å–ç»Ÿè®¡
                const statsRes = await fetch(`${API_BASE}/api/admin/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
                
                if (statsRes.status === 401 || statsRes.status === 403) {
                    alert("æƒé™éªŒè¯å¤±è´¥ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæˆ–ç™»å½•å·²è¿‡æœŸã€‚");
                    window.location.href = 'index.html';
                    return;
                }
                
                const stats = await statsRes.json();
                updateStatsCards(stats);
                renderCharts(stats);

                // 2.2 è·å–æ¶ˆæ¯
                const msgRes = await fetch(`${API_BASE}/api/admin/feedbacks`, { headers: { 'Authorization': `Bearer ${token}` } });
                const msgs = await msgRes.json();
                renderMessages(msgs);

                // 2.3 è·å–ç”¨æˆ·
                const userRes = await fetch(`${API_BASE}/api/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await userRes.json();
                renderUsers(users);

            } catch (err) {
                console.error(err);
                document.getElementById('stat-users').innerText = 'Err';
                // ä¸è¦åœ¨è¿™é‡ŒæŠ¥é”™ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜
            }
        }

        function updateStatsCards(data) {
            // æ·»åŠ ç®€å•çš„è®¡æ•°åŠ¨ç”»
            document.getElementById('stat-users').innerText = data.users || 0;
            document.getElementById('stat-pros').innerText = data.pros || 0;
            document.getElementById('stat-basic').innerText = data.basic || 0;
            document.getElementById('stat-unread').innerText = data.unread || 0;
        }

        function renderCharts(data) {
            // é”€æ¯æ—§å›¾è¡¨é˜²æ­¢é‡å 
            const ctx = document.getElementById('userChart').getContext('2d');
            if (window.myUserChart) window.myUserChart.destroy();

            const freeUsers = data.users - data.basic - data.pros;

            window.myUserChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å…è´¹ç”¨æˆ·', 'Basic ä¼šå‘˜', 'Pro ä¼šå‘˜'],
                    datasets: [{
                        data: [freeUsers, data.basic, data.pros],
                        backgroundColor: ['#E5E7EB', '#10B981', '#8B5CF6'], // ç°ï¼Œç»¿ï¼Œç´«
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function renderMessages(msgs) {
            const container = document.getElementById('msg-list');
            if (!msgs || msgs.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-400">æš‚æ— åé¦ˆæ¶ˆæ¯</div>';
                return;
            }
            container.innerHTML = '';
            msgs.forEach(msg => {
                const tagColor = msg.type === 'Bug' ? 'bg-red-100 text-red-700' : (msg.type === 'Priority' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-50 text-blue-600');
                const isVIP = msg.isVIP ? '<i class="fas fa-crown text-yellow-500 ml-1"></i>' : '';
                
                container.innerHTML += `
                    <div class="p-4 border-b border-gray-50 hover:bg-gray-50 transition">
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-gray-800 text-sm">${msg.name} ${isVIP}</span>
                            <span class="text-xs text-gray-400">${new Date(msg.submittedAt).toLocaleDateString()}</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs ${tagColor} px-2 py-0.5 rounded">${msg.type}</span>
                            <span class="text-xs text-gray-400">${msg.email}</span>
                        </div>
                        <p class="text-sm text-gray-600 line-clamp-2">${msg.message}</p>
                    </div>
                `;
            });
        }

        function renderUsers(users) {
            const tbody = document.getElementById('user-list');
            tbody.innerHTML = '';
            users.forEach(user => {
                let badge = '<span class="px-2 py-1 rounded text-xs bg-gray-200 text-gray-600">Free</span>';
                if(user.plan === 'basic') badge = '<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-700 font-bold">Basic</span>';
                if(user.plan === 'pro') badge = '<span class="px-2 py-1 rounded text-xs bg-purple-100 text-purple-700 font-bold">Pro</span>';
                if(user.role === 'admin') badge = '<span class="px-2 py-1 rounded text-xs bg-black text-white font-bold">ADMIN</span>';

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 font-medium text-gray-900">${user.name || 'User'}</td>
                        <td class="px-6 py-4 text-gray-500 text-sm">${user.email}</td>
                        <td class="px-6 py-4">${badge}</td>
                        <td class="px-6 py-4 text-gray-400 text-sm">${new Date(user.createdAt).toLocaleDateString()}</td>
                    </tr>
                `;
            });
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
